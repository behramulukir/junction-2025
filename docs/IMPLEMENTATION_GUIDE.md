# EU Legislation RAG System - Implementation Guide

## Overview
This system processes ~90K EU legislation JSON files into a semantic search and RAG (Retrieval-Augmented Generation) system for finding regulatory overlaps and contradictions.

## Prerequisites
1. **GCP Project Setup**
   - Project ID: `nimble-granite-478311-u2`
   - Enable Vertex AI API
   - Enable Cloud Storage API
   - Setup authentication: `gcloud auth application-default login`

2. **Install Dependencies**
   ```bash
   pip install -r requirements.txt
   pip install -r requirements_vertexai.txt
   ```

## Pipeline Steps

### Step 1: Preprocessing (✅ COMPLETED)
- Filtered 94,544 → 61,791 valid JSON files
- Generated semantic chunks (~150K-200K expected)
- Extracted metadata (regulation names, articles, years, citations)
- Output: `processed_chunks/chunks_batch_*.jsonl`
- Uploaded to: `gs://bof-hackathon-data/vector_data/`

**Files**: `preprocess_local.py`, `config.yaml`

---

### Step 2: Generate Embeddings (✅ COMPLETED)

**Script**: `generate_embeddings_parallel.py` (Cloud Run Jobs)

**What it does**:
- Reads JSONL chunks from GCS
- Enriches text with metadata (regulation name, article, year)
- Generates 768-dim embeddings using Vertex AI text-embedding-005
- Uploads embeddings to GCS in batches

**Run**:
```bash
# Basic run (uses defaults from script)
python generate_embeddings.py

# With custom parameters
python generate_embeddings.py \
  --project-id nimble-granite-478311-u2 \
  --bucket-name bof-hackathon-data \
  --input-prefix vector_data/ \
  --output-prefix embeddings/ \
  --batch-size 250 \
  --write-interval 10000
```

**Completed Output**:
- Files in `gs://bof-hackathon-data/embeddings/`
- 31 files generated by 10 parallel workers
- **274,269 total embeddings** (768 dimensions each)
- Format: `embeddings_worker{00-09}_batch_*.jsonl`
- Each line: `{"id": "uuid_chunkid", "embedding": [768 floats], "metadata": {...}}`

**Execution**: Parallel Cloud Run Jobs (10 workers)
**Time**: ~15 minutes
**Cost**: ~$3.50 (one-time)

---

### Step 3: Build Vector Search Index (⏳ IN PROGRESS)

**Script**: `build_vector_index.py`

**Status**: Index creation started at 2025-11-15 17:25 UTC
**Index ID**: `1775625516951273472`

**What it does**:
- Creates Vertex AI Vector Search TreeAH index
- Deploys index to an endpoint for querying
- Configures for high-recall semantic search

**Run**:
```bash
# Create index and deploy (full pipeline)
python build_vector_index.py

# Create index only (skip deployment)
python build_vector_index.py --skip-deployment

# Deploy existing index later
python build_vector_index.py --deploy-only <INDEX_RESOURCE_NAME>

# Custom configuration
python build_vector_index.py \
  --project-id nimble-granite-478311-u2 \
  --bucket-name bof-hackathon-data \
  --embeddings-prefix embeddings/ \
  --machine-type n1-standard-16 \
  --min-replicas 1 \
  --max-replicas 3
```

**Expected Output**:
```
INDEX READY!
Resource name: projects/.../locations/us-central1/indexes/123456
Save this resource name!

DEPLOYMENT COMPLETE!
Endpoint: projects/.../locations/us-central1/indexEndpoints/789012
Deployed Index ID: eu_legislation_deployed
```

**IMPORTANT**: Save the endpoint resource name for Step 4!

**Monitor Progress**:
```bash
# Check index status
gcloud ai indexes list --region=us-central1

# View detailed status
gcloud ai indexes describe 1775625516951273472 --region=us-central1
```

**Time**: 
- Index creation: 1-2 hours (IN PROGRESS)
- Deployment: 30 minutes (will start after creation)

**Cost**: 
- Creation: ~$10-20 (one-time)
- Hosting: ~$50-100/month (n1-standard-16, 1 replica)

---

### Step 4: Query with RAG System

**Script**: `rag_search.py`

**What it does**:
- Converts user queries to embeddings
- Searches vector index for similar regulations
- Filters by risk category and year
- Analyzes results with Gemini LLM for overlaps/contradictions
- Returns structured findings with citations

**Run**:
```bash
# Example query
python rag_search.py \
  --index-endpoint "projects/123/locations/us-central1/indexEndpoints/456" \
  --query "What regulations conflict with GDPR Article 6 regarding consent?" \
  --risk-category data_privacy \
  --year-filter 2016 \
  --top-k 50

# Without LLM analysis (faster, cheaper)
python rag_search.py \
  --index-endpoint "..." \
  --query "Financial stability regulations for banks" \
  --risk-category financial_regulation \
  --no-llm

# List available risk categories
python rag_search.py --help
```

**Risk Categories**:
- `data_privacy` - GDPR, ePrivacy, personal data
- `financial_regulation` - MiFID, Basel, capital requirements
- `consumer_protection` - Consumer rights, unfair terms
- `environmental` - Emissions, sustainability, climate
- `health_safety` - Food safety, medical devices
- `market_conduct` - Competition, market abuse
- `employment` - Working time, labor conditions
- `telecommunications` - Electronic communications, networks
- `transport` - Aviation, maritime, road transport
- `energy` - Energy efficiency, renewables
- `trade` - Customs, tariffs, trade agreements
- `taxation` - VAT, excise, tax evasion
- `insurance` - Solvency, insurance undertakings
- `payments` - Payment services, PSD2, electronic money
- `aml_cft` - Money laundering, terrorist financing

**Output Format**:
```
SEARCH RESULTS
==================================================
Query: What regulations conflict with GDPR...
Risk Category: data_privacy
Year Filter: >= 2016
Total Results: 45

TOP 5 MATCHES:
1. Regulation (EU) 2016/679 (GDPR)
   Article: 6 | Year: 2016
   Score: 0.892
   Text: Lawfulness of processing...

LLM ANALYSIS
==================================================
SUMMARY
Found 3 potential conflicts and 2 overlapping provisions...

KEY FINDINGS
1. [CRITICAL] GDPR Article 6 vs ePrivacy Directive...
2. [HIGH] Data retention periods conflicting...

CONTRADICTIONS
- GDPR requires explicit consent (Art 6(1)(a))
- Telecom Regulation mandates 6-month retention (Art 15)
...

RECOMMENDATIONS
1. Seek legal clarification on data retention
2. Implement consent mechanisms compliant with both...
```

**Cost per query**: ~$0.006 (with LLM analysis)

---

## Architecture Summary

```
┌─────────────────────────────────────────────────────────────────────┐
│                         USER QUERY                                  │
│              "Find GDPR conflicts with telecom regs"                │
└──────────────────────────┬──────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                   1. QUERY VECTORIZATION                            │
│          Vertex AI text-embedding-005 (768 dims)                    │
└──────────────────────────┬──────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                   2. VECTOR SEARCH                                  │
│    Vertex AI Vector Search (TreeAH Index, 150K vectors)             │
│    Filters: risk_category, year >= X                                │
│    Returns: Top 50 most similar chunks                              │
└──────────────────────────┬──────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                   3. RISK FILTERING                                 │
│    Apply risk category keywords                                     │
│    Reduces to ~30 most relevant chunks                              │
└──────────────────────────┬──────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                   4. LLM ANALYSIS                                   │
│    Gemini 1.5 Flash (1M context window)                             │
│    Analyzes for: contradictions, overlaps, relationships            │
│    Returns: Structured findings with citations                      │
└──────────────────────────┬──────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                   RESULTS TO USER                                   │
│    - Top matching regulations with scores                           │
│    - Article-level citations                                        │
│    - Conflict analysis with severity ratings                        │
│    - Compliance recommendations                                     │
└─────────────────────────────────────────────────────────────────────┘
```

## Troubleshooting

### Embeddings Generation Issues
```bash
# Check GCS access
gsutil ls gs://bof-hackathon-data/vector_data/

# Test with small batch
python generate_embeddings.py --write-interval 100

# Check API quotas
gcloud alpha quotas describe textembedding.googleapis.com/embedding_requests_per_minute
```

### Index Building Issues
```bash
# Check Vertex AI API enabled
gcloud services list --enabled | grep aiplatform

# List existing indexes
gcloud ai indexes list --region=us-central1

# Check index status
gcloud ai indexes describe <INDEX_ID> --region=us-central1
```

### Query Issues
```bash
# Test endpoint connectivity
gcloud ai index-endpoints describe <ENDPOINT_ID> --region=us-central1

# Check deployed indexes
gcloud ai index-endpoints deployed-indexes list <ENDPOINT_ID> --region=us-central1
```

## Progress Summary

1. ✅ **Preprocessing completed** - 61,791 files → 274,269 chunks
2. ✅ **Embeddings generated** - 274,269 embeddings (768 dims) via parallel Cloud Run
3. ⏳ **Building index** - Vertex AI Vector Search (ETA: 1-2 hours)
4. ⏳ **Deploy index** - Auto-deploys after creation
5. ⏳ **Test queries** - `python rag_search.py --query "..."`

**Current Status**: Index creation in progress (started 17:25 UTC)
**Next Action**: Wait for index completion, then test queries

## Cost Estimates

| Component | One-Time | Monthly |
|-----------|----------|---------|
| Embeddings | $1.50 | - |
| Index Creation | $15 | - |
| Index Hosting | - | $75 |
| Queries (1000) | - | $6 |
| **Total** | **$16.50** | **$81** |

## References
- [Vertex AI Vector Search](https://cloud.google.com/vertex-ai/docs/vector-search/overview)
- [text-embedding-005](https://cloud.google.com/vertex-ai/docs/generative-ai/embeddings/get-text-embeddings)
- [Gemini API](https://cloud.google.com/vertex-ai/docs/generative-ai/model-reference/gemini)
